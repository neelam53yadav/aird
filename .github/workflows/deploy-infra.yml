name: Deploy Infrastructure

on:
  push:
    branches:
      - main
      - db-fixes
    paths:
      - 'infra/terraform/**'
      - '.github/workflows/deploy-infra.yml'
  pull_request:
    branches:
      - main
      - db-fixes
    paths:
      - 'infra/terraform/**'
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action (plan = preview changes, apply = create/update VM, destroy = delete VM)'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
      auto_approve:
        description: 'Auto-approve apply/destroy (skip confirmation)'
        required: false
        default: false
        type: boolean

env:
  GCP_PROJECT_ID: project-f3c8a334-a3f2-4f66-a06
  GCP_REGION: us-central1
  GCP_ZONE: us-central1-c
  TF_VERSION: 1.6.0

jobs:
  terraform:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/890841479962/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-actions@project-f3c8a334-a3f2-4f66-a06.iam.gserviceaccount.com
          create_credentials_file: true

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        # Note: Project is already set via CLOUDSDK_CORE_PROJECT environment variable
        # Skipping explicit project setting to avoid token refresh issues

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: infra/terraform
        run: terraform init

      - name: Auto-Import Existing Resources
        working-directory: infra/terraform
        env:
          PROJECT_ID: ${{ env.GCP_PROJECT_ID }}
          ZONE: ${{ env.GCP_ZONE }}
          ENVIRONMENT: beta
          VM_NAME: primedata-beta
        run: |
          SA_EMAIL="primedata-compute-sa-${ENVIRONMENT}@${PROJECT_ID}.iam.gserviceaccount.com"
          
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "Checking for existing resources and importing into Terraform state..."
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          
          IMPORT_COUNT=0
          SKIP_COUNT=0
          ERROR_COUNT=0
          
          # Check if service account exists and import
          if gcloud iam service-accounts describe ${SA_EMAIL} --project=${PROJECT_ID} &>/dev/null; then
            echo "üìã Service Account exists: ${SA_EMAIL}"
            if terraform import google_service_account.primedata_sa projects/${PROJECT_ID}/serviceAccounts/${SA_EMAIL} 2>&1; then
              echo "  ‚úÖ Imported successfully"
              ((IMPORT_COUNT++))
            else
              IMPORT_ERROR=$?
              if terraform state show google_service_account.primedata_sa &>/dev/null; then
                echo "  ‚ö†Ô∏è  Already in state (import skipped)"
                ((SKIP_COUNT++))
              else
                echo "  ‚ùå Import failed (error code: ${IMPORT_ERROR})"
                ((ERROR_COUNT++))
              fi
            fi
          else
            echo "üìã Service Account does not exist (will be created)"
          fi
          echo ""
          
          # Check and import firewall rules
          if gcloud compute firewall-rules describe primedata-allow-http-${ENVIRONMENT} --project=${PROJECT_ID} &>/dev/null; then
            echo "üî• Firewall Rule exists: primedata-allow-http-${ENVIRONMENT}"
            if terraform import google_compute_firewall.allow_http projects/${PROJECT_ID}/global/firewalls/primedata-allow-http-${ENVIRONMENT} 2>&1; then
              echo "  ‚úÖ Imported successfully"
              ((IMPORT_COUNT++))
            else
              IMPORT_ERROR=$?
              if terraform state show google_compute_firewall.allow_http &>/dev/null; then
                echo "  ‚ö†Ô∏è  Already in state (import skipped)"
                ((SKIP_COUNT++))
              else
                echo "  ‚ùå Import failed (error code: ${IMPORT_ERROR})"
                ((ERROR_COUNT++))
              fi
            fi
          else
            echo "üî• Firewall Rule does not exist: primedata-allow-http-${ENVIRONMENT} (will be created)"
          fi
          echo ""
          
          if gcloud compute firewall-rules describe primedata-allow-https-${ENVIRONMENT} --project=${PROJECT_ID} &>/dev/null; then
            echo "üî• Firewall Rule exists: primedata-allow-https-${ENVIRONMENT}"
            if terraform import google_compute_firewall.allow_https projects/${PROJECT_ID}/global/firewalls/primedata-allow-https-${ENVIRONMENT} 2>&1; then
              echo "  ‚úÖ Imported successfully"
              ((IMPORT_COUNT++))
            else
              IMPORT_ERROR=$?
              if terraform state show google_compute_firewall.allow_https &>/dev/null; then
                echo "  ‚ö†Ô∏è  Already in state (import skipped)"
                ((SKIP_COUNT++))
              else
                echo "  ‚ùå Import failed (error code: ${IMPORT_ERROR})"
                ((ERROR_COUNT++))
              fi
            fi
          else
            echo "üî• Firewall Rule does not exist: primedata-allow-https-${ENVIRONMENT} (will be created)"
          fi
          echo ""
          
          if gcloud compute firewall-rules describe primedata-allow-ssh-${ENVIRONMENT} --project=${PROJECT_ID} &>/dev/null; then
            echo "üî• Firewall Rule exists: primedata-allow-ssh-${ENVIRONMENT}"
            if terraform import google_compute_firewall.allow_ssh projects/${PROJECT_ID}/global/firewalls/primedata-allow-ssh-${ENVIRONMENT} 2>&1; then
              echo "  ‚úÖ Imported successfully"
              ((IMPORT_COUNT++))
            else
              IMPORT_ERROR=$?
              if terraform state show google_compute_firewall.allow_ssh &>/dev/null; then
                echo "  ‚ö†Ô∏è  Already in state (import skipped)"
                ((SKIP_COUNT++))
              else
                echo "  ‚ùå Import failed (error code: ${IMPORT_ERROR})"
                ((ERROR_COUNT++))
              fi
            fi
          else
            echo "üî• Firewall Rule does not exist: primedata-allow-ssh-${ENVIRONMENT} (will be created)"
          fi
          echo ""
          
          # Check and import VM
          if gcloud compute instances describe ${VM_NAME} --zone=${ZONE} --project=${PROJECT_ID} &>/dev/null; then
            echo "üñ•Ô∏è  VM Instance exists: ${VM_NAME}"
            if terraform import google_compute_instance.primedata_vm projects/${PROJECT_ID}/zones/${ZONE}/instances/${VM_NAME} 2>&1; then
              echo "  ‚úÖ Imported successfully"
              ((IMPORT_COUNT++))
            else
              IMPORT_ERROR=$?
              if terraform state show google_compute_instance.primedata_vm &>/dev/null; then
                echo "  ‚ö†Ô∏è  Already in state (import skipped)"
                ((SKIP_COUNT++))
              else
                echo "  ‚ùå Import failed (error code: ${IMPORT_ERROR})"
                ((ERROR_COUNT++))
              fi
            fi
          else
            echo "üñ•Ô∏è  VM Instance does not exist (will be created)"
          fi
          echo ""
          
          # Import IAM bindings (try to import, but don't fail if they don't exist in state format)
          echo "üîê Attempting to import IAM bindings..."
          terraform import google_project_iam_member.storage_admin "${PROJECT_ID} roles/storage.admin serviceAccount:${SA_EMAIL}" 2>&1 | grep -v "already in state" || echo "  Storage admin binding handled"
          terraform import google_project_iam_member.cloudsql_client "${PROJECT_ID} roles/cloudsql.client serviceAccount:${SA_EMAIL}" 2>&1 | grep -v "already in state" || echo "  CloudSQL client binding handled"
          terraform import google_project_iam_member.compute_instance_admin "${PROJECT_ID} roles/compute.instanceAdmin.v1 serviceAccount:${SA_EMAIL}" 2>&1 | grep -v "already in state" || echo "  Compute admin binding handled"
          echo ""
          
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "Import Summary:"
          echo "  ‚úÖ Successfully imported: ${IMPORT_COUNT}"
          echo "  ‚ö†Ô∏è  Already in state: ${SKIP_COUNT}"
          echo "  ‚ùå Import errors: ${ERROR_COUNT}"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          
          # Refresh state to ensure everything is synced
          echo "Refreshing Terraform state..."
          terraform refresh -no-color 2>&1 | head -20 || echo "Refresh completed (warnings are OK)"

      - name: Terraform Format Check
        working-directory: infra/terraform
        run: terraform fmt -check

      - name: Terraform Validate
        working-directory: infra/terraform
        run: terraform validate

      - name: Check if Resources Exist Before Plan
        id: check-resources
        working-directory: infra/terraform
        env:
          PROJECT_ID: ${{ env.GCP_PROJECT_ID }}
          ZONE: ${{ env.GCP_ZONE }}
          ENVIRONMENT: beta
          VM_NAME: primedata-beta
        run: |
          SA_EMAIL="primedata-compute-sa-${ENVIRONMENT}@${PROJECT_ID}.iam.gserviceaccount.com"
          
          RESOURCES_EXIST=false
          
          # Check if any resources exist in GCP
          if gcloud iam service-accounts describe ${SA_EMAIL} --project=${PROJECT_ID} &>/dev/null || \
             gcloud compute firewall-rules describe primedata-allow-http-${ENVIRONMENT} --project=${PROJECT_ID} &>/dev/null || \
             gcloud compute instances describe ${VM_NAME} --zone=${ZONE} --project=${PROJECT_ID} &>/dev/null; then
            RESOURCES_EXIST=true
          fi
          
          echo "resources_exist=${RESOURCES_EXIST}" >> $GITHUB_OUTPUT
          echo "Resources exist in GCP: ${RESOURCES_EXIST}"

      - name: Terraform Plan
        id: plan
        working-directory: infra/terraform
        run: |
          # Terraform is idempotent - it will skip resources that already exist
          # If resources exist, plan will show "no changes" or only show differences
          terraform plan -out=tfplan -no-color 2>&1 | tee /tmp/terraform-plan-output.txt
        continue-on-error: true

      - name: Terraform Plan Status
        if: steps.plan.outcome == 'failure'
        run: |
          echo "=== Terraform Plan Failed ==="
          echo ""
          echo "Actual Terraform error output:"
          cat /tmp/terraform-plan-output.txt || echo "Could not read plan output"
          echo ""
          
          # Check if resources exist but weren't imported
          if [ "${{ steps.check-resources.outputs.resources_exist }}" == "true" ]; then
            echo "‚ö†Ô∏è  WARNING: Resources exist in GCP but plan failed!"
            echo ""
            echo "This usually means:"
            echo "1. Resources exist but weren't successfully imported into Terraform state"
            echo "2. Terraform is trying to create resources that already exist"
            echo ""
            echo "Solution: The import step above should have handled this."
            echo "If imports failed, check the import step output for errors."
            echo ""
            echo "Skipping apply to avoid permission errors..."
            echo "::warning::Skipping apply - resources exist but imports may have failed"
          else
            echo "Common causes:"
            echo "1. Authentication issues"
            echo "2. Invalid configuration"
            echo "3. Missing required APIs (enable them in GCP)"
            exit 1
          fi

      - name: Ensure VM Startup Script
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply'
        working-directory: infra/terraform
        run: |
          VM_NAME="primedata-beta"
          ZONE="us-central1-c"
          
          # Check if VM exists and add startup script if missing
          if gcloud compute instances describe ${VM_NAME} --zone=${ZONE} --project=${{ env.GCP_PROJECT_ID }} &>/dev/null; then
            echo "Checking VM startup script..."
            CURRENT_SCRIPT=$(gcloud compute instances describe ${VM_NAME} \
              --zone=${ZONE} \
              --project=${{ env.GCP_PROJECT_ID }} \
              --format="value(metadata.items[key=startup-script].value)" 2>/dev/null || echo "")
            
            if [ -z "$CURRENT_SCRIPT" ] || [ "$CURRENT_SCRIPT" == "" ]; then
              echo "Adding startup script to VM..."
              if [ -f "scripts/startup.sh" ]; then
                gcloud compute instances add-metadata ${VM_NAME} \
                  --zone=${ZONE} \
                  --project=${{ env.GCP_PROJECT_ID }} \
                  --metadata-from-file=startup-script=scripts/startup.sh
                echo "‚úÖ Startup script added"
              else
                echo "‚ö†Ô∏è  Warning: startup script file not found at scripts/startup.sh"
              fi
            else
              echo "‚úÖ Startup script already exists on VM"
            fi
          else
            echo "VM does not exist yet, will be created by Terraform"
          fi

      - name: Terraform Apply
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply' && steps.plan.outcome == 'success'
        working-directory: infra/terraform
        run: |
          # Check if plan shows resources would be created (and they already exist)
          PLAN_OUTPUT=$(cat /tmp/terraform-plan-output.txt || echo "")
          
          if echo "$PLAN_OUTPUT" | grep -q "will be created" && [ "${{ steps.check-resources.outputs.resources_exist }}" == "true" ]; then
            echo "‚ö†Ô∏è  WARNING: Plan shows resources will be created, but they already exist in GCP!"
            echo "This means imports may have failed. Checking what needs to be created..."
            echo ""
            
            # Check each resource individually
            if echo "$PLAN_OUTPUT" | grep -q "google_service_account.primedata_sa.*will be created"; then
              if gcloud iam service-accounts describe primedata-compute-sa-beta@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com --project=${{ env.GCP_PROJECT_ID }} &>/dev/null; then
                echo "‚ùå Service account exists but Terraform wants to create it - import failed!"
                echo "Skipping apply to avoid permission errors."
                exit 0
              fi
            fi
            
            if echo "$PLAN_OUTPUT" | grep -q "google_compute_firewall.*will be created"; then
              if gcloud compute firewall-rules describe primedata-allow-http-beta --project=${{ env.GCP_PROJECT_ID }} &>/dev/null || \
                 gcloud compute firewall-rules describe primedata-allow-https-beta --project=${{ env.GCP_PROJECT_ID }} &>/dev/null || \
                 gcloud compute firewall-rules describe primedata-allow-ssh-beta --project=${{ env.GCP_PROJECT_ID }} &>/dev/null; then
                echo "‚ùå Firewall rules exist but Terraform wants to create them - import failed!"
                echo "Skipping apply to avoid permission errors."
                exit 0
              fi
            fi
            
            if echo "$PLAN_OUTPUT" | grep -q "google_compute_instance.primedata_vm.*will be created"; then
              if gcloud compute instances describe primedata-beta --zone=${{ env.GCP_ZONE }} --project=${{ env.GCP_PROJECT_ID }} &>/dev/null; then
                echo "‚ùå VM exists but Terraform wants to create it - import failed!"
                echo "Skipping apply to avoid permission errors."
                exit 0
              fi
            fi
          fi
          
          # If we get here, it's safe to apply
          if [ "${{ github.event.inputs.auto_approve }}" == "true" ]; then
            terraform apply -auto-approve tfplan
          else
            terraform apply tfplan
          fi

      - name: Ensure VM Startup Script (Auto)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/db-fixes'
        working-directory: infra/terraform
        run: |
          VM_NAME="primedata-beta"
          ZONE="us-central1-c"
          
          # Check if VM exists and add startup script if missing
          if gcloud compute instances describe ${VM_NAME} --zone=${ZONE} --project=${{ env.GCP_PROJECT_ID }} &>/dev/null; then
            echo "Checking VM startup script..."
            CURRENT_SCRIPT=$(gcloud compute instances describe ${VM_NAME} \
              --zone=${ZONE} \
              --project=${{ env.GCP_PROJECT_ID }} \
              --format="value(metadata.items[key=startup-script].value)" 2>/dev/null || echo "")
            
            if [ -z "$CURRENT_SCRIPT" ] || [ "$CURRENT_SCRIPT" == "" ]; then
              echo "Adding startup script to VM..."
              if [ -f "scripts/startup.sh" ]; then
                gcloud compute instances add-metadata ${VM_NAME} \
                  --zone=${ZONE} \
                  --project=${{ env.GCP_PROJECT_ID }} \
                  --metadata-from-file=startup-script=scripts/startup.sh
                echo "‚úÖ Startup script added"
              else
                echo "‚ö†Ô∏è  Warning: startup script file not found at scripts/startup.sh"
              fi
            else
              echo "‚úÖ Startup script already exists on VM"
            fi
          else
            echo "VM does not exist yet, will be created by Terraform"
          fi

      - name: Terraform Apply (Auto on main/db-fixes)
        if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/db-fixes') && steps.plan.outcome == 'success'
        working-directory: infra/terraform
        run: |
          # Check if plan shows resources would be created (and they already exist)
          PLAN_OUTPUT=$(cat /tmp/terraform-plan-output.txt || echo "")
          
          if echo "$PLAN_OUTPUT" | grep -q "will be created" && [ "${{ steps.check-resources.outputs.resources_exist }}" == "true" ]; then
            echo "‚ö†Ô∏è  WARNING: Plan shows resources will be created, but they already exist in GCP!"
            echo "Checking which resources need to be created..."
            echo ""
            
            # Check each resource individually
            if echo "$PLAN_OUTPUT" | grep -q "google_service_account.primedata_sa.*will be created"; then
              if gcloud iam service-accounts describe primedata-compute-sa-beta@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com --project=${{ env.GCP_PROJECT_ID }} &>/dev/null; then
                echo "‚ùå Service account exists but Terraform wants to create it - import failed!"
                echo "Skipping apply to avoid permission errors."
                exit 0
              fi
            fi
            
            if echo "$PLAN_OUTPUT" | grep -q "google_compute_firewall.*will be created"; then
              if gcloud compute firewall-rules describe primedata-allow-http-beta --project=${{ env.GCP_PROJECT_ID }} &>/dev/null || \
                 gcloud compute firewall-rules describe primedata-allow-https-beta --project=${{ env.GCP_PROJECT_ID }} &>/dev/null || \
                 gcloud compute firewall-rules describe primedata-allow-ssh-beta --project=${{ env.GCP_PROJECT_ID }} &>/dev/null; then
                echo "‚ùå Firewall rules exist but Terraform wants to create them - import failed!"
                echo "Skipping apply to avoid permission errors."
                exit 0
              fi
            fi
            
            if echo "$PLAN_OUTPUT" | grep -q "google_compute_instance.primedata_vm.*will be created"; then
              if gcloud compute instances describe primedata-beta --zone=${{ env.GCP_ZONE }} --project=${{ env.GCP_PROJECT_ID }} &>/dev/null; then
                echo "‚ùå VM exists but Terraform wants to create it - import failed!"
                echo "Skipping apply to avoid permission errors."
                exit 0
              fi
            fi
          fi
          
          # If we get here, it's safe to apply
          terraform apply -auto-approve tfplan

      - name: Terraform Output
        if: steps.plan.outcome == 'success'
        working-directory: infra/terraform
        run: terraform output -json

